services:
    postgres:
        image: postgres:16-alpine
        ports:
            - '54321:5432'
        volumes:
            - postgres:/var/lib/postgresql/data
        environment:
            POSTGRES_USER: user
            POSTGRES_PASSWORD: password
    php:
        restart: unless-stopped
        depends_on:
            - postgres
        build:
            context: ./docker
            dockerfile: ./php/php.Dockerfile
        ports: [ '8001:8000' ]
        volumes:
            - ./application:/var/task
            - ./application/var/cache:/tmp/cache
            - ./application/var/log:/tmp/log
            - ./docker/php/conf.d:/opt/bref/etc/php/conf.d
        environment:
            HANDLER: public/index.php
            DOCUMENT_ROOT: public
        user: 1000:1000
    php-consumer:
        restart: unless-stopped
        build:
            context: ./docker
            dockerfile: ./php/php.Dockerfile
        depends_on:
            - php
        volumes:
            - ./application:/var/task
            - ./docker/php/conf.d:/opt/bref/etc/php/conf.d
        command: ["bin/console", "messenger:consume", "scheduler_default", "--time-limit=300"]

volumes:
    postgres:
        driver: local
